<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="author" content="shenjinxiang,likestarsjx@gmail.com">
<meta name="description" content="申锦祥的个人博客">
<meta name="keywords" content="Java,JavaScript,HTML,CSS,canvas,Linux,shenjinxiang,LikeStar">
<meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport">
<meta content="yes" name="apple-mobile-web-app-capable">
<meta content="black" name="apple-mobile-web-app-status-bar-style">
<meta content="telephone=no" name="format-detection">
<meta name="renderer" content="webkit">
<link rel="icon" href="/images/title.ico" type="image/x-ico">
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/plugin/prism/prism.css">
<title>LikeStar</title>
</head>
<body>
<div class="sidebar fadeInDown animated">
	<div class="logo-title">
		<div class="title">
			<h1>
				<a href="/">LikeStar<span>.BLOG</span></a>
			</h1>
			<div class="description">
				<p>申锦祥的个人博客</p>
			</div>
		</div> 
	</div> 
	<div class="footer">
		<span>ShenJinXiang</span>
	</div>
</div>

<div class="page-top animated fadeInDown">
	<ul class="nav">
		<li>
			<a href="/">
				<i class="baseline"></i>
				首 页
			</a>
		</li>
		<li>
			<a href="/pages/archives" >
				<i class="baseline"></i>
				归 档
			</a>
		</li>
		<li>
			<a href="/pages/demo">
				<i class="baseline"></i>
				DEMO
			</a>
		</li>
	</ul>
</div>



<div class='main'>
	<div class='autopagerize_page_element'>
		<div class='content'>
			<div class='post animated fadeInDown'>
	<div class='post-title'>
		<h2>
			<a href='/pages/posts/nodejs/2017/02/10/express-mysql-ejs员工管理系统/'>express-mysql-ejs员工管理系统</a>
		</h2>
	</div>
	<div class='post-content'>
		<p><p>之前介绍过express、ejs的使用，也介绍了nodejs操作mysql数据库，现在将这些整合起来，做一个简单的员工管理系统</p>

<h3>功能说明</h3>

<ul><li>数据存储在mysql数据库中，后台用express框架</li>
<li>包含一个登陆、注册页面和主页面</li>
<li>主页面包括左侧的部门信息，以及右侧的员工列表，可以添加删除修改员工和部门信息</li>
</ul>
<h3>目录结构</h3>
<p>创建工作目录employee</p>
<pre class="language-none">
<code>$ mkdir employee</code>
</pre>

<pre class="language-none">
<code>employee/
  |-- app.js                               应用启动文件    
  |-- package.json                         项目总信息文件     
  |-- lib/                                 存放后台js文件    
  |   |-- middleware/                      中间件目录，自定义的中间件    
  |   |-- routes/                          路由目录，用于配置路由    
  |   |-- service/                         业务层目录，后台主要业务都在这个目录下    
  |   |-- sql/                             数据库表设计sql文件    
  |   |-- utils/                           工具目录，包括md5加密和操作数据库的工具文件    
  |   |-- config.json                      配置文件    
  |
  |-- node_modules/                        依赖的第三方包    
  |-- public/                              静态文件目录，包括前段第三方插件、页面css、js文件    
  |-- views/                               存放ejs文件    </code>
</pre>

<h3>初始化环境</h3>
<p>初始化包，创建package.json</p>
<pre class="language-none">
<code>$ npm init</code>
</pre>

<p>导入express</p>
<pre class="language-none">
<code>$ npm install express --save</code>
</pre>

<p>导入mysql包</p>
<pre class="language-none">
<code>$ npm install mysql --save</code>
</pre>

<p>导入ejs模板引擎</p>
<pre class="language-none">
<code>$ npm install ejs --save</code>
</pre>

<p>导入uuid，用于生成数据库主键id</p>
<pre class="language-none">
<code>$ npm install node-uuid --save</code>
</pre>

<p>导入body-parser包，用于解析post请求数据</p>
<pre class="language-none">
<code>$ npm install body-parser --save</code>
</pre>

<p>导入express-session包，用于管理session</p>
<pre class="language-none">
<code>$ npm install express-session --save</code>
</pre>

<p>创建静态文件根目录public</p>
<pre class="language-none">
<code>$ mkdir public</code>
</pre>

<p>public目录下创建plugin目录，存放前段第三方插件</p>
<pre class="language-none">
<code>$ mkdir public/plugin</code>
</pre>

<p>plugin目录中导入第三方插件:</p>
<ul><li>jquery.js - jquery插件</li>
<li>jquery.form.js - jquery from表单插件</li>
<li>ztrr - 树形控件</li>
<li>layer - 弹出框控件</li>
</ul>
<h3>项目配置文件</h3>
<p>创建lib目录</p>
<pre class="language-none">
<code>$ mkdir lib</code>
</pre>

<p>lib目录下创建config.json</p>
<pre class="language-none">
<code>$ touch lib/config.json</code>
</pre>

<p>编辑config.json</p>
<pre class="language-json">
<code>{
	"mysql": {
		"user": "root",
		"password": "6098",
		"host": "localhost",
		"port": 3306,
		"database": "nodejs",
		"connectionLimit": 10
	},
	"noLogin": ["/", "/login", "/register", "/checkUsername"]
}</code>
</pre>
<p>mysql指明数据库配置信息</p>
<ul><li>user - 数据库用户名</li>
<li>password - 数据库用户密码</li>
<li>host - 数据库地址</li>
<li>port - 数据库端口</li>
<li>database - 数据库名</li>
<li>connectionLimit - 连接池连接数</li>
</ul>
<p>noLogin 指明拦截配置信息，除了noLogin指定的路由，其他所有请求都需要session验证</p>

<h3>创建MD5工具模块</h3>
<p>有登录、注册功能，针对密码做个简单的MD5处理，lib目录下创建utils目录</p>
<pre class="language-none">
<code>$ mkdir lib/utils</code>
</pre>

<p>utils目录下创建MD5Util.js</p>
<pre class="language-none">
<code>$ touch lib/utils/MD5Util.js</code>
</pre>

<p>编辑MD5Util.js</p>
<pre class="language-javascript">
<code>// lib/utils/MD5Util.js
const crypto = require('crypto');

exports.md5 = function (content) {
	if (typeof content !== 'string') {
		return '';
	}
	let md5 = crypto.createHash('md5');
	md5.update(content);
	return md5.digest('hex');
};

exports.sha1 = function (content) {
	if (typeof content !== 'string') {
		return '';
	}
	let shasum = crypto.createHash('sha1');
	shasum.update(content);
	return shasum.digest('hex');
};</code>
</pre>

<h3>创建数据库操作模块</h3>
<p>utils目录下创建mysqlUtil.js</p>
<pre class="language-none">
<code>$ touch /lib/utils/mysqlUtil.js</code>
</pre>

<p>编辑mysqlUtil.js文件</p>
<pre class="language-javascript">
<code>// lib/utils/mysqlUtil.js
const mysql = require('mysql');
const dbConfig = require('../Config').mysql;

let pool = mysql.createPool(dbConfig);

/**
 * 通用查询
 */
let query = exports.query = function (sql, callback) {
	console.log(sql);
	pool.getConnection(function (err, conn) {
		if (err) {
			callback(err);
		} else {
			conn.query(sql, function (err, rows, fields) {
				conn.release();
				console.log(rows);
				callback(err, rows, fields);
			});
		}
	});
};

/**
 * 判断obj是否为对象，也不是{}，即至少有一个属性
 */
let isNotEmptyObject = function (obj) {
	if (typeof obj !== 'object') {
		return false;
	}
	for (let k in obj) {
		return true;
	}
	return false;
}

/**
 * 根据id获取一条记录
 * tableName 数据库表名
 * idName 表主键的名称，默认为'id'
 * idValue 表主键的值
 * callback 回调函数
 */
exports.findById = function () {
	let tableName, idName, idValue, callback;
	if (arguments.length === 3) {
		tableName = arguments[0];
		idName = 'id';
		idValue = arguments[1];
		callback = arguments[2];
	} else if (arguments.length == 4) {
		tableName = arguments[0];
		idName = arguments[1];
		idValue = arguments[2];
		callback = arguments[3];
	} else {
		throw new Error('参数个数错误');
	}
	query({
		sql: 'select * from ' + tableName + ' where ' + idName + ' = ?',
		values: [idValue]
	}, function (err, data) {
		if (err) {
			callback(err);
		} else {
			if (data.length === 0) {
				callback(null, {});
			} else if (data.length === 1) {
				callback(null, data[0]);
			} else {
				callback(new Error('结果错误'));
			}
		}
	});
};

/**
 * 保存一条记录
 * tableName 表名
 * obj 要保存的对象
 * callback 回调函数
 */
exports.save = function(tableName, obj, callback) {
	if (!isNotEmptyObject(obj)) {
		callback(new Error('参数错误'));
		return;
	}
	let sql = 'insert into ' + tableName + ' (';
	let temp = 'values (';
	let values = [];

	for (let k in obj) {
		sql += ' `' + k + '`,';
		temp += ' ?,';
		values.push(obj[k]);
	}
	sql = sql.substring(0, sql.length - 1) + ') ';
	temp = temp.substring(0, temp.length - 1) + ') ';
	sql += temp;
	query({sql: sql, values: values}, function (err, data) {
		callback(err, data);
	});
};

/**
 * 修改一条记录
 * tableName 对应的数据库表名
 * idName 对应的数据库表主键名称
 * obj 修改的对象
 * callback 回调函数
 */
exports.update = function () {
	let tableName, idName, obj, callback;
	if (arguments.length === 3) {
		tableName = arguments[0];
		idName = 'id';
		obj = arguments[1];
		callback = arguments[2];
	} else if (arguments.length === 4) {
		idName = arguments[1];
		obj = arguments[2];
		callback = arguments[3];
	} else {
		throw new Error('参数个数错误');
	}
	if (!isNotEmptyObject(obj)) {
		callback(new Error('参数错误'));
		return;
	}
	if (!obj[idName]) {
		callback(new Error('参数错误'));
		return;
	}

	let sql = 'update ' + tableName + ' set';
	let values = [];
	for (let k in obj) {
		if (k !== idName) {
			sql += ' `' + k + '` = ?,'
			values.push(obj[k]);
		}
	}
	sql = sql.substring(0, sql.length - 1) + ' where ' + idName + ' = ? ';
	values.push(obj[idName]);

	query({sql: sql, values: values}, function (err, data) {
		callback(err, data);
	});
};

/**
 * 根据id删除一条记录
 */
exports.delById = function () {
	let tableName, idName, idValue, callback;
	if (arguments.length === 3) {
		tableName = arguments[0];
		idName = 'id';
		idValue = arguments[1];
		callback = arguments[2]
	} else if (arguments.length === 4) {
		tableName = arguments[0];
		idName = arguments[1];
		idValue = arguments[2];
		callback = arguments[3]
	} else {
		throw new Error('参数个数错误');
	}

	let sql = 'delete from ' + tableName + ' where ' + idName + ' = ?';
	let values = [idValue];
	query({sql: sql, values: values}, function (err, data) {
		callback(err, data);
	});
};</code>
</pre>

<h3>创建数据库表</h3>
<p>lib目录下创建sql目录</p>
<pre class="language-none">
<code>$ mkdir lib/sql</code>
</pre>

<p>sql目录下创建mysql.sql文件</p>
<pre class="language-none">
<code>$ touch lib/sql/mysql.sql</code>
</pre>

<p>由于功能简单，所以数据库表只有3个，user表，用于登录、注册；department部门表，为树形结构数据以及employee员工表，编辑mysql.sql</p>
<pre class="language-sql">
<code>/**
 * // lib/sql/mysql.sql
 * 初始化数据库表
 */

-- 用户表
CREATE TABLE `user` (
  `id` varchar(64) NOT NULL COMMENT '主键id',
  `name` varchar(255) DEFAULT NULL COMMENT '名称',
  `username` varchar(255) DEFAULT NULL COMMENT '登录用户名',
  `password` varchar(255) DEFAULT NULL COMMENT '登录密码',
  `registerDate` date DEFAULT NULL COMMENT '注册日期',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- 用户表插入系统管理员记录
insert into user (`id`, `name`, `username`, `password`, `registerDate`) values (UUID(), '系统管理员', 'admin', MD5('admin'), now());

-- 部门表
CREATE TABLE `department` (
  `id` varchar(64) NOT NULL COMMENT '主键id',
  `name` varchar(255) DEFAULT NULL COMMENT '名称',
  `pId` varchar(64) DEFAULT NULL COMMENT '上级部门id',
  `createTime` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- 员工表
CREATE TABLE `employee` (
  `id` varchar(64) NOT NULL COMMENT '主键id',
  `name` varchar(255) DEFAULT NULL COMMENT '姓名',
  `departmentId` varchar(64) DEFAULT NULL COMMENT '部门id',
  `age` int(3) DEFAULT NULL COMMENT '年龄',
  `sex` int(1) DEFAULT NULL COMMENT '性别 1 男   2 女',
  `address` varchar(255) DEFAULT NULL COMMENT '地址',
  `desc` text COMMENT '说明',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;</code>
</pre>

<p>命令行登录mysql服务器，执行下面的命令，运行sql脚本</p>
<pre class="language-none">
<code>mysql&gt; use nodejs;
mysql&gt; source ~/Users/shenjinxiang/Documents/employee/lib/sql/mysql.sql;</code>
</pre>

<h3>搭建express应用</h3>
<p>创建app.js文件</p>
<pre class="language-none">
<code>$ touch app.js</code>
</pre>

<p>编辑app.js</p>
<pre class="language-javascript">
<code>// app.js
const express = require('express');
const path = require('path');
const url = require('url');

let app = express();

/**
 * 设置视图，引入ejs
 */
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'ejs');

/**
 * 设置静态文件路面
 */
app.use(express.static(path.join(__dirname, 'public')));

/**
 * 引入express-session
 */
app.use(require('express-session')({
	secret: 'shenjinxiang',
	saveUninitialized: true
}));

/**
 * 引入body-parser
 */
app.use(require('body-parser')());

app.listen(3000, function () {
	console.log('Server running at 3000 port.');
});</code>
</pre>

<p>一个简单的应用已经好了，当然，现在没有引入任何路由，项目启动起来也没有任何意义</p>

<h3>添加自定义中间件</h3>
<p><b>创建路由日志中间件</b></p>

<p>lib目录下创建middleware目录</p>
<pre class="language-none">
<code>$ mkdir lib/middleware</code>
</pre>

<p>middleware目录下创建routerLog.js文件</p>
<pre class="language-none">
<code>$ touch lib/middleware/routerLog.js</code>
</pre>

<p>编辑routerLog.js文件</p>
<pre class="language-javascript">
<code>// lib/middleware/routeLog.js
const url = require('url');
const util = require('util');

/**
 * 用于打印每次请求的路径和参数
 */
module.exports = function(req, res, next) {
	let pathname = url.parse(req.url).pathname;
	util.log('请求路径:', pathname);
	if (req.method === 'GET' || req.method === 'get') {
		util.log('Get请求，参数:', req.query);
		next();
	} else if (req.method === 'POST' || req.method === 'post') {
		util.log('POST请求，参数:', req.body);
		next();
	}
};</code>
</pre>

<p><b>登录session验证中间件</b></p>

<p>middleware目录下创建loginFilter.js</p>
<pre class="language-none">
<code>$ touch lib/middleware/loginFilter.js</code>
</pre>

<p>编辑loginFilter.js文件</p>
<pre class="language-javascript">
<code>// lib/middleware/loginFilter.js
const noLogin = require('../config').noLogin;
const url = require('url');

/**
 * 登录session验证 中间件
 */
module.exports = function (req, res, next) {
	let pathname = url.parse(req.url).pathname;
	if (noLogin.indexOf(pathname) &lt; 0 && !req.session.currentUser) {
		res.redirect('/');
	} else {
		next();
	}
};</code>
</pre>

<p>app.js中添加自定义中间件</p>
<pre class="language-javascript">
<code>/**
 * 引入路由日志
 */
app.use(require('./lib/middleware/routeLog'));

/**
 * 登录拦截器
 */
app.use(require('./lib/middleware/loginFilter'));</code>
</pre>

<h3>配置路由模块</h3>
<p>lib目录下创建routes目录</p>
<pre class="language-none">
<code>$ mkdir lib/routes</code>
</pre>

<p>routes目录下创建index.js、department.js、employee.js文件</p>
<pre class="language-none">
<code>$ touch lib/routes/index.js
$ touch lib/routes/department.js
$ touch lib/routes/employee.js</code>
</pre>

<p>编辑刚创建的三个文件，内容都为:</p>
<pre class="language-javascript">
<code>const express = require('express');

let router = express.Router();

module.exports = router;</code>
</pre>

<p>app.js中配置这三个路由文件，app.js最终内容为:</p>
<pre class="language-javascript">
<code>// app.js
const express = require('express');
const path = require('path');
const url = require('url');

let app = express();

/**
 * 设置视图，引入ejs
 */
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'ejs');

/**
 * 设置静态文件路面
 */
app.use(express.static(path.join(__dirname, 'public')));

/**
 * 引入express-session
 */
app.use(require('express-session')({
	secret: 'shenjinxiang',
	saveUninitialized: true
}));

/**
 * 引入body-parser
 */
app.use(require('body-parser')());

/**
 * 引入路由日志
 */
app.use(require('./lib/middleware/routeLog'));

/**
 * 登录拦截器
 */
app.use(require('./lib/middleware/loginFilter'));

app.use('/', require('./lib/routes/index'));
// 部门路由
app.use('/department', require('./lib/routes/department'));
// 员工路由
app.use('/employee', require('./lib/routes/employee'));


app.listen(3000, function () {
	console.log('Server running at 3000 port.');
});</code>
</pre>

<h3>添加页面css文件</h3>
<p>public目录下创建css目录</p>
<pre class="language-none">
<code>$ mkdir public/css</code>
</pre>

<p>css目录中创建common.css文件</p>
<pre class="language-none">
<code>$ touch public/css/common.css</code>
</pre>

<p>common.css内容</p>
<pre class="language-css">
<code>* {
	margin: 0;
	padding: 0;
	font-size: 12px;
}
div {
	box-sizing: border-box;
}
ul li {
	list-style: none;
}
.clear {
	clear: both;
}
.fl {
	float: letf;
}
.fr {
	float: right;
}
.index-content {
	width: 500px;
	margin: 200px auto;
	border-radius: 5px;
	box-shadow: 0px 0px 20px #ccc;
	border: 1px solid #ddd;
}
.index-menu {
	height: 60px;
	line-height: 60px;
}
.index-menu li {
	float: left;
	width: 50%;
	font-size: 14px;
	font-weight: bold;
	text-align: center;
	background: #eee;
	cursor: pointer;
}
.index-menu li.login-li {
	border-radius: 5px 0 0 0;
}
.index-menu li.register-li {
	border-radius: 0 5px 0 0;
}
.index-menu li:hover {
	background: #ddd;
}
.index-menu li.active {
	background: #428bca;
	color: #fff;
}
.list-content {
	display: none;
	margin: 20px 0;
}
.list-content li{
	line-height: 40px;
	text-align: center;
	padding: 5px;
	margin: 5px;
}
.list-content li input[type='text'],
.list-content li input[type='password'] {
	width: 80%;
	height: 32px;
	border-radius: 3px;
	border: 1px solid #ccc;
	padding: 2px 10px;
}
.list-content li input[type='button'] {
	width: 85%;
	height: 40px;
	border-radius: 3px;
	border: none;
	background: #428bca;
	color: #fff;
	cursor: pointer;
}
.list-content li input[type='button']:hover {
	background: #327bba;
}
.list-content.active{
	display: block;
}

.header {
	width: 100%;
	height: 100px;
	background: linear-gradient(#ddd, #fefefe);
	line-height: 100px;
}
.header .title {
	font-size: 26px;
	width: 200px;
	line-height: 100px;
	float: left;
	text-indent: 50px;
}
.header span {
	font-size: 14px;
	display: inline-block;
	float: right;
	margin-right: 20px;
}
.header a {
	font-size: 12px;
	display: inline-block;
	float: right;
}
.left-content {
	float: left;
	width: 20%;
	border: 1px solid #ccc;
}
.right-content {
	float: right;
	width: 79.5%;
	border: 1px solid #ccc;
}

.box-title {
	width: 100%;
	height: 42px;
	line-height: 42px;
	text-indent: 15px;
	background: #ddd;
	color: #444;
	font-weight: bold;
	font-size: 14px;
}
.box-title a {
	display: inline-block;
	float: right;
	line-height: 36px;
	padding: 0 10px;
	text-decoration: none;
	color: #444;
}
.box-title a:hover {
	color: #222;
}
.operate-box {
	width: 100%;
	height: 54px;
	line-height: 54px;
	border-bottom: 1px solid #eee;
	text-align: center;
}
.operate-box button {
	display: inline-block;
	cursor: pointer;
	border: 1px solid transparent;
	padding: 0 10px;
	width: 80px;
	height: 28px;
}

#departmentTree {
	overflow-y: auto;
}
.table-ware {
	width: 100%;
	overflow-y: auto;
}
.table {
	width: 100%;
	border-collapse: collapse;
}
.table th, 
.table td {
	border: 1px solid #ddd;
	height: 34px;
	line-height: 34px;
	text-indent: 10px;
}
.table&gt; tbody &gt; tr:nth-child(odd) &gt; td,
.table&gt; tbody &gt; tr:nth-child(odd) &gt; th {
	background-color: #f9f9f9;
}
.table&gt; tbody &gt; tr:hover &gt; td,
.table&gt; tbody &gt; tr:hover &gt; th {
	background-color: #f5f5f5;
}
.form-ul {
	line-height: 40px;
	text-align: center;
	padding: 5px;
	margin: 5px;
}
.form-ul ._text {
	width: 80%;
	height: 32px;
	border-radius: 3px;
	border: 1px solid #ccc;
	padding: 2px 10px;
}
.form-ul ._text:focus {
	border-color: #66afe9;
	outline: 0;
	-webkit-box-shadow: inset 0 1px 1pxrgba(0,0,0,.075), 0 0 8px rgba(102, 175, 233, .6);
	box-shadow: inset 0 1px 1pxrgba(0,0,0,.075), 0 0 8px rgba(102, 175, 233, .6);
}
input[type="file"]:focus,
input[type="radio"]:focus,
input[type="checkbox"]:focus {
	outline: thin dotted;
	outline: 5px auto -webkit-focus-ring-color;
	outline-offset: -2px;
}
.form-ul label {
	display: inline-block;
	text-align: left;
	text-indent: 5px;
	width: 80px;
}
.form-ul textarea._text {
	height: 80px;
	resize: none;
	margin-top: 6px;
}
.form-ul ._btn {
	width: 100px;
	height: 32px;
	color: #444;
	background-color: #eee;
	border-radius: 4px;
	border: 1px solid #ccc;
	cursor: pointer;
	margin: 10px 20px;
}
.form-ul ._btn:hover {
	background-color: #fefefe;
}</code>
</pre>

<h3>添加页面公用js文件</h3>
<p>public 目录下创建js目录</p>
<pre class="language-none">
<code>$ mkdir public/js</code>
</pre>

<p>js目录下创建common.js</p>
<pre class="language-none">
<code>$ touch public/js/common.js</code>
</pre>

<p>common.js文件内容</p>
<pre class="language-javascript">
<code>// public/js/common.js
/**
 * 获取form表单数据
 */
$.fn.getFormJson = function() {  
   var o = {};  
   var a = this.serializeArray();  
   $.each(a, function() {  
       if (o[this.name]) {  
           if (!o[this.name].push) {  
               o[this.name] = [o[this.name]];  
           }  
           o[this.name].push(this.value || '');  
       } else {  
           o[this.name] = this.value || '';  
       }  
   });  
   return o;  
}; 

/**
 * 重置表单
 */
function formReset(formId){
	var $form = $("#"+formId);
	$form.get(0).reset();
	$form.find("input[type='hidden']").val("");
}

/**
 * 执行ajax post请求
 */
function doPost(url, data, callback) {
	$.ajax({
		type: 'POST',
		url: url,
		data: data,
		dataType: 'json',
		success: callback
	});
}

/**
 * 提示信息 用于表单验证
 */
function tips(str, key) {
	layer.tips(str, '#' + key);
}

/**
 * 弹出提示信息
 */
function alertMsg (str, fn) {
	if (typeof fn === 'function') {
		layer.msg(str, {time: 2000}, fn);
	} else {
		layer.msg(str, {time: 2000});
	}
}

/**
 * 弹出layer窗口
 */
function openContent(title, width, contentId) {
	layer.open({
		type: 1, 
		area: [width + 'px', 'auto'],
		title: title,
		shade: 0.6, 
		anim: 1,
		content: $('#' + contentId)
	}); 
}

/**
 * 关闭layer弹出窗口
 */
function closeLayer() {
	layer.closeAll();
}</code>
</pre>

<h3>登录、注册模块</h3>
<p>创建views目录</p>
<pre class="language-none">
<code>$ mkdir views</code>
</pre>

<p>创建登录页面index.ejs</p>
<pre class="language-none">
<code>$ touch views/index.ejs</code>
</pre>

<p>index.ejs 文件内容</p>
<pre class="language-html">
<code>&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;meta charset='utf-8'&gt;
	&lt;link type='text/css' rel='stylesheet' href='/plugin/ztree/zTreeStyle.css' /&gt;
	&lt;link type='text/css' rel='stylesheet' href='/plugin/layer/skin/default/layer.css' /&gt;
	&lt;link type='text/css' rel='stylesheet' href='/css/common.css' /&gt;
	&lt;title&gt;员工管理系统&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class='index-content'&gt;
	&lt;ul class='index-menu'&gt;
		&lt;li class='login-li active' data='0'&gt;登 录&lt;/li&gt;
		&lt;li class='register-li' data='1'&gt;注 册&lt;/li&gt;
	&lt;/ul&gt;
	&lt;i class='clear'&gt;&lt;/i&gt;
	&lt;div id='login-content' class='list-content active'&gt;
		&lt;form id='loginForm'&gt;
			&lt;ul&gt;
				&lt;li&gt;
					&lt;input type='text' id='login_username' name='username' placeholder='请输入用户名' /&gt;
				&lt;/li&gt;
				&lt;li&gt;
					&lt;input type='password' id='login_password' name='password' placeholder='请输入密码' /&gt;
				&lt;/li&gt;
				&lt;li&gt;
					&lt;input type='button' value='登  录' onclick='login()'/&gt;
				&lt;/li&gt;
			&lt;/ul&gt;
		&lt;/form&gt;
	&lt;/div&gt;
	&lt;div id='register-content' class='list-content'&gt;
		&lt;form id='registerForm'&gt;
			&lt;ul&gt;
				&lt;li&gt;
					&lt;input type='text' id='register_name' name='name' placeholder='请输入姓名' /&gt;
				&lt;/li&gt;
				&lt;li&gt;
					&lt;input type='text' id='register_username' name='username' placeholder='请输入用户名' /&gt;
				&lt;/li&gt;
				&lt;li&gt;
					&lt;input type='password' id='register_password' name='password' placeholder='请输入密码' /&gt;
				&lt;/li&gt;
				&lt;li&gt;
					&lt;input type='button' value='注  册' onclick='register()'/&gt;
				&lt;/li&gt;
			&lt;/ul&gt;
		&lt;/form&gt;
	&lt;/div&gt;
&lt;/div&gt;
&lt;script type='text/javascript' src='/plugin/jquery.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/plugin/jquery.form.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/plugin/layer/layer.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/plugin/ztree/jquery.ztree.core-3.5.min.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/plugin/ztree/jquery.ztree.excheck-3.5.min.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/js/common.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/js/index.js'&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code>
</pre>

<p><b>登录、注册页面的js文件</b></p>

<p>public/js 目录下创建文件 index.js</p>
<pre class="language-none">
<code>$ touch public/js/index.js</code>
</pre>

<p>public/js/index.js文件内容</p>
<pre class="language-javascript">
<code>$(function () {
	bindEvent();
});

/**
 * 绑定事件
 */
function bindEvent() {
	$('.index-menu li').click(function () {
		$(this).addClass('active');
		$(this).siblings().removeClass('active');
		let data = $(this).attr('data');
		$('.list-content').eq(data).addClass('active').siblings().removeClass('active');
	});

	$('#login_username').keypress(function (event) {
		if (event.keyCode === 13) {
			$('#login_password').focus();
		}
	});

	$('#login_password').keypress(function (event) {
		if (event.keyCode === 13) {
			login();
		}
	});

	$('#register_name').keypress(function (event) {
		if (event.keyCode === 13) {
			$('#register_username').focus();
		}
	});
	
	$('#register_username').keypress(function (event) {
		if (event.keyCode === 13) {
			$('#register_password').focus();
		}
	});

	$('#register_password').keypress(function (event) {
		if (event.keyCode === 13) {
			register();
		}
	});

	$('#register_username').blur(function () {
		if ($.trim($(this).val()) != '') {
			checkUsername($(this).val());
		}
	});
}

/**
 * 登录
 */
function login() {
	let data = $('#loginForm').getFormJson();
	if (data.username === '' || $.trim(data.username) === '') {
		tips('请输入用户名', 'login_username');
		return;
	}
	if (data.password === '' || $.trim(data.password) === '') {
		tips('请输入密码', 'login_password');
		return;
	}
	doPost('/login', data, function(result) {
		if (result.result) {
			window.location.href = '/main';
		} else {
			alertMsg(result.msg);
		}
	});
}

/**
 * 注册
 */
function register() {
	let data = $('#registerForm').getFormJson();
	if (data.name === '' || $.trim(data.name) === '') {
		tips('请输入姓名', 'register_name');
		return;
	}
	if (data.username === '' || $.trim(data.username) === '') {
		tips('请输入用户名', 'register_username');
		return;
	}
	if (data.password === '' || $.trim(data.password) === '') {
		tips('请输入密码', 'register_password');
		return;
	}
	doPost('/register', data, function (result) {
		if (result.result) {
			window.location.href = '/main';
		} else {
			alertMsg(result.msg);
		}
	});
}

/**
 * 检测用户名是否重复
 */
function checkUsername(username) {
	doPost('/checkUsername', {username: username}, function (result) {
		if (!result.result) {
			tips(result.msg, 'register_username');
		}
	});
}</code>
</pre>

<p><b>编辑lib/routes/index.js文件</b></p>
<pre class="language-javascript">
<code>// lib/routes/index.js
const express = require('express');
const userService = require('../service/user');
const MD5 = require('../utils/MD5Util');

let router = express.Router();

/**
 * 登录、注册页面
 */
router.get('/', function (req, res) {
	res.render('index');
});

/**
 * 登录验证
 */
router.post('/login', function (req, res) {
	let username = req.body.username;
	let password = req.body.password;
	userService.queryUserByUsername(username, function (err, data) {
		if (err) {
			res.json({result: false, msg: '用户不存在'});
		} else {
			if (data.length === 1 && data[0].password === MD5.md5(password)) {
				req.session.currentUser = data[0];
				res.json({result: true});
			} else {
				res.json({result: false, msg: '用户或密码错误'});
			}
		}
	});
});

/**
 * 注册用户
 */
router.post('/register', function (req, res) {
	userService.register(req.body, function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			req.session.currentUser = data;
			res.json({result: true});
		}
	});
});

/**
 * 验证用户名是否存在
 */
router.post('/checkUsername', function (req, res) {
	userService.queryUserByUsername(req.body.username, function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			if (data.length &gt; 0) {
				res.json({result: false, msg: '用户名已经存在'});
			} else {
				res.json({result: true});
			}
		}
	});
});

/**
 * 登出
 */
router.get('/logout', function (req, res) {
	delete req.session.currentUser;
	res.redirect('/');
});

/**
 * 主页面
 */
router.get('/main', function (req, res){
	let user = req.session.currentUser;
	res.render('main', {name: user.name});
});

module.exports = router;</code>
</pre>

<p><b>业务处理</b></p>

<p>创建lib/service目录</p>
<pre class="language-none">
<code>$ mkdir lib/service</code>
</pre>

<p>创建lib/service/user.js文件</p>
<pre class="language-none">
<code>$ touch lib/service/user.js</code>
</pre>

<p>lib/service/user.js文件内容</p>
<pre class="language-javascript">
<code>// lib/service/user.js

const mysqlUtil = require('../utils/mysqlUtil');
const uuid = require('node-uuid');
const MD5 = require('../utils/MD5Util');

/**
 * 根据用户名获取用户信息
 */
let queryUserByUsername = exports.queryUserByUsername = function (username, callback) {
	mysqlUtil.query({
		sql: 'select * from user where username = ?',
		values: [username]
	}, callback);
};

/**
 * 注册
 */
exports.register = function (obj, callback) {
	queryUserByUsername(obj.username, function (err, data) {
		if (err) {
			callback(err);
		} else if (data.length &gt; 0) {
			callback(new Error('用户名已存在'));
		} else {
			obj.id = uuid.v4();
			obj.registerDate = new Date();
			obj.password = MD5.md5(obj.password);
			mysqlUtil.save('user', obj, function (err, data) {
				if (err) {
					callback(err);
				} else {
					mysqlUtil.findById('user', obj.id, function (err, data) {
						callback(err, data);
					});
				}
			});
		}
	});
};</code>
</pre>

<p>这个模块中，使用了node-uuid包，用于生成数据库中主键id，至此登录、注册功能完成</p>

<h3>主页面开发</h3>
<p>在lib/routes/index.js这个路由中配置了/main 路由，用于跳转至主页面</p>
<pre class="language-javascript">
<code>/**
 * 主页面
 */
router.get('/main', function (req, res){
	let user = req.session.currentUser;
	res.render('main', {name: user.name});
});</code>
</pre>

<p>下面开始主页面的开发</p>

<p>创建views/main.ejs文件</p>
<pre class="language-none">
<code>$ touch views/main.ejs</code>
</pre>

<p>编辑main.ejs文件</p>
<pre class="language-html">
<code>&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;meta charset='utf-8'&gt;
	&lt;link type='text/css' rel='stylesheet' href='/plugin/ztree/zTreeStyle.css' /&gt;
	&lt;link type='text/css' rel='stylesheet' href='/plugin/layer/skin/default/layer.css' /&gt;
	&lt;link type='text/css' rel='stylesheet' href='/css/common.css' /&gt;
	&lt;title&gt;员工管理系统&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class='header'&gt;
	&lt;div class='title'&gt;员工管理&lt;/div&gt;
	&lt;span&gt;当前用户：&lt;%= name %&gt;&nbsp;&nbsp;&lt;a href='/logout'&gt;退出登录&lt;/a&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='left-content'&gt;
	&lt;div class='box-title'&gt;部门&lt;/div&gt;
	&lt;div class='operate-box'&gt;
		&lt;button type='button' class='_btn' id='add_department_btn'&gt;新增&lt;/button&gt;
		&lt;button type='button' class='_btn' id='upd_department_btn'&gt;修改&lt;/button&gt;
		&lt;button type='button' class='_btn' id='del_department_btn'&gt;删除&lt;/button&gt;
	&lt;/div&gt;
	&lt;ul id='departmentTree' class='ztree'&gt;&lt;/ul&gt;
&lt;/div&gt;
&lt;div class='right-content'&gt;
	&lt;div class='box-title'&gt;员工
		&lt;a href='javascript:addEmployee();'&gt;添加员工&lt;/a&gt;
	&lt;/div&gt;
	&lt;div class='table-ware'&gt;
	&lt;table id='employeeTable' class='table'&gt;
		&lt;thead&gt;
			&lt;tr&gt;
				&lt;th&gt;姓名&lt;/th&gt;
				&lt;th&gt;年龄&lt;/th&gt;
				&lt;th&gt;性别&lt;/th&gt;
				&lt;th&gt;所属部门&lt;/th&gt;
				&lt;th&gt;地址&lt;/th&gt;
				&lt;th&gt;说明&lt;/th&gt;
				&lt;th&gt;操作&lt;/th&gt;
			&lt;/tr&gt;
		&lt;/thead&gt;
		&lt;tbody&gt;
			&lt;tr&gt;
				&lt;td colspan='7'&gt;暂无数据.&lt;/td&gt;
			&lt;/tr&gt;
		&lt;/tbody&gt;
	&lt;/table&gt;
	&lt;/div&gt;
&lt;/div&gt;

&lt;div id='departmentContent' style='display: none;'&gt;
	&lt;form id='departmentForm'&gt;
		&lt;ul class='form-ul'&gt;
			&lt;li&gt;
				&lt;input type='hidden' id='department_pId' name='pId' /&gt;
				&lt;input type='text' id='department_pName'  class='_text' readonly /&gt;
			&lt;/li&gt;
			&lt;li&gt;
				&lt;input type='hidden' id='department_id' name='id' /&gt;
				&lt;input type='text' id='department_name' name='name' class='_text' placeholder='请输入部门名称' /&gt;
			&lt;/li&gt;
			&lt;li&gt;
				&lt;button type='button' class='_btn' onclick='saveDepartment()'&gt;确定&lt;/button&gt;
				&lt;button type='button' class='_btn' onclick='closeLayer()'&gt;取消&lt;/button&gt;
			&lt;/li&gt;
		&lt;/ul&gt;
	&lt;/form&gt;
&lt;/div&gt;

&lt;div id='employeeContent' style='display: none;'&gt;
	&lt;form id='employeeForm'&gt;
		&lt;ul class='form-ul'&gt;
			&lt;li&gt;
				&lt;input type='hidden' id='employee_id' name='id' /&gt;
				&lt;input type='text' id='employee_name' name='name' placeholder='请输入姓名' class='_text' /&gt;
			&lt;/li&gt;
			&lt;li&gt;
				&lt;input type='number' id='employee_age' name='age' placeholder='请输入年龄' class='_text' /&gt;
			&lt;/li&gt;
			&lt;li&gt;
				&lt;input type='radio' name='sex' checked value='1' id='sex_1'/&gt;&lt;label for='sex_1'&gt;男&lt;/label&gt;
				&lt;input type='radio' name='sex' value='0' id='sex_0' /&gt;&lt;label for='sex_0'&gt;女&lt;/label&gt;
				
			&lt;/li&gt;
			&lt;li&gt;
				&lt;input type='text' id='employee_address' name='address' class='_text' placeholder='请输入地址' /&gt;
			&lt;/li&gt;
			&lt;li&gt;
				&lt;input type='hidden' id='employee_departmentId' name='departmentId' /&gt;
				&lt;input type='text' id='employee_departmentName' readonly  class='_text' /&gt;
			&lt;/li&gt;
			&lt;li&gt;
				&lt;textarea id='employee_desc' name='desc' class='_text' placeholder='请输入说明'&gt;&lt;/textarea&gt;
			&lt;/li&gt;
			&lt;li&gt;
				&lt;button type='button' class='_btn' onclick='saveEmployee()'&gt;确定&lt;/button&gt;
				&lt;button type='button' class='_btn' onclick='closeLayer()'&gt;取消&lt;/button&gt;
			&lt;/li&gt;
		&lt;/ul&gt;
	&lt;/form&gt;
&lt;/div&gt;
&lt;script type='text/javascript' src='/plugin/jquery.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/plugin/jquery.form.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/plugin/layer/layer.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/plugin/ztree/jquery.ztree.core-3.5.min.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/plugin/ztree/jquery.ztree.excheck-3.5.min.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/js/common.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/js/main.js'&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code>
</pre>

<p><b>添加对应的页面js文件</b></p>

<p>创建 public/js/main.js文件</p>
<pre class="language-none">
<code>$ touch public/js/main.js</code>
</pre>

<p>编辑public/js/main.js文件</p>
<pre class="language-javascript">
<code>$(function () {
	initUI();
	bindEvent();
	initDepartmentTree();
});

/**
 * 初始化高度
 */
function initUI() {
	$('.left-content').height($(window).height() - 120);
	$('#departmentTree').height($(window).height() - 240);
	$('.right-content').height($(window).height() - 120);
	$('.table-ware').height($(window).height() - 170);
}

/**
 * 绑定事件
 */
function bindEvent() {
	$('#add_department_btn').click(addDepartment);
	$('#upd_department_btn').click(updDepartment);
	$('#del_department_btn').click(delDepartment);
}

/**
 * 初始化部门树
 */
function initDepartmentTree() {
	doPost('/department/treeData', {}, function (result) {
		if (result.result) {
			let zNodes = result.data;
			let setting = {
				data: {
					simpleData: {
						enable: true,
						idKey: 'id',
						pIdKey: 'pId',
						rootPId: null
					}
				},
				view: {
					selectedMulti: false	// 设置只能选中一个节点
				},
				callback: {
					onClick: deptClick
				}
			};
			$.fn.zTree.init($('#departmentTree'), setting, zNodes);
		}
	});
}

/**
 * 获取zTree对象
 */
function getZTreeObj(id) {
	return $.fn.zTree.getZTreeObj(id);
}

/**
 * 获取选中的节点
 */
function getSelectedNode(id) {
	let nodes = getZTreeObj(id).getSelectedNodes();
	if (!nodes || nodes.length === 0) {
		return null;
	}
	return nodes[0];
}

/**
 * 节点点击时触发 显示员工列表
 */
function deptClick (event, treeId, treeNode) {
	let departmentId = treeNode.id;
	initEmployeeList(departmentId);
}

/**
 * 添加部门，弹出输入框
 */
function addDepartment () {
	formReset('departmentForm');
	let currentNode = getSelectedNode('departmentTree');
	if (!currentNode) {
		$('#department_pId').val('');
		$('#department_pName').val('没有上级部门');
	} else {
		$('#department_pId').val(currentNode.id);
		$('#department_pName').val(currentNode.name);
	}
	openContent('添加部门', 400, 'departmentContent');
}

/**
 * 修改部门 弹出输入框
 */
function updDepartment () {
	formReset('departmentForm');
	let currentNode = getSelectedNode('departmentTree');
	if (!currentNode) {
		alertMsg('请选择需要修改的部门');
		return;
	}
	doPost('/department/queryOne', {id: currentNode.id}, function (result) {
		if (!result.result) {
			alertMsg(result.msg);
		} else {
			$('#department_id').val(result.data.id);
			$('#department_name').val(result.data.name);
			$('#department_pName').val(result.data.pName || '没有上级部门');
			openContent('修改部门', 400, 'departmentContent');
		}
	});
}

/**
 * 保存部门数据 后台执行添加或修改操作
 */
function saveDepartment () {
	let data = $('#departmentForm').getFormJson();
	if (data.name === '' || $.trim(data.name) == '') {
		tips('请输入部门名称', 'department_name');
		return;
	}
	let url = '/department/addDepartment';
	if (data.id) {
		url = '/department/updDepartment';
	}
	doPost(url, data, function (result) {
		if (!result.result) {
			alertMsg(result.msg);
		} else {
			let treeObj = getZTreeObj('departmentTree');
			let currentNode = getSelectedNode('departmentTree');
			if (result.data.type === 'add') {
				treeObj.addNodes(currentNode, result.data.data);
				alertMsg('添加成功', function () {
					closeLayer();
				});
			} else if (result.data.type === 'upd') {
				currentNode.name = result.data.data.name;
				treeObj.updateNode(currentNode);
				alertMsg('修改成功', function () {
					closeLayer();
				});
			}
		}
	});
}

/**
 * 删除部门，需要该部门没有下级部门，没有员工
 */
function delDepartment () {
	let currentNode = getSelectedNode('departmentTree');
	if (!currentNode || !currentNode.id) {
		alertMsg('请选择需要删除的部门');
		return;
	}
	if (currentNode.isParent) {
		alertMsg('有下级部门，不能删除!');
		return;
	}

	doPost('/department/delDepartment', {id: currentNode.id}, function (result) {
		if (!result.result) {
			alertMsg(result.msg);
		} else {
			let treeObj = getZTreeObj('departmentTree');
			treeObj.removeNode(currentNode);
			alertMsg('删除成功');
		}
	});
}

/**
 * 显示员工列表
 */
function initEmployeeList(departmentId) {
	doPost('/employee/queryList', {'departmentId': departmentId}, function (result) {
		if (!result.result) {
			alertMsg(result.msg);
		} else {
			if (result.data.length === 0) {
				$('#employeeTable tbody').html('&lt;tr&gt;&lt;td colspan="7"&gt;暂无数据.&lt;/td&gt;&lt;/tr&gt;');
			} else {
				$('#employeeTable tbody').html('');
				result.data.forEach(function(item, index) {
					let _html = '&lt;tr&gt;'
										+ '	&lt;td&gt;' + item.name + '&lt;/td&gt;'
										+ '	&lt;td&gt;' + item.age + '&lt;/td&gt;'
										+ '	&lt;td&gt;' + ((item.sex == '1') ? '男' : '女') + '&lt;/td&gt;'
										+ '	&lt;td&gt;' + item.departmentName + '&lt;/td&gt;'
										+ '	&lt;td&gt;' + item.address + '&lt;/td&gt;'
										+ '	&lt;td&gt;' + item.desc + '&lt;/td&gt;'
										+ '	&lt;td&gt;'
										+ "		&lt;a href=\"javascript:updEmployee('" + item.id + "')\"&gt;修改&lt;/a&gt;"
										+ "		&lt;a href=\"javascript:delEmployee('" + item.id + "')\"&gt;删除&lt;/a&gt;"
										+ '	&lt;/td&gt;'
										+ '&lt;/tr&gt;';
					$('#employeeTable tbody').append($(_html));
				});
			}
		}
	});
}

/**
 * 添加员工 弹出窗口
 */
function addEmployee() {
	let currentNode = getSelectedNode('departmentTree');
	if (!currentNode || !currentNode.id) {
		alertMsg('请选择部门');
		return;
	}
	formReset('employeeForm');
	$('#employeeForm #employee_departmentId').val(currentNode.id);
	$('#employeeForm #employee_departmentName').val(currentNode.name);
	openContent('添加员工', 500, 'employeeContent');
}

/**
 * 修改员工，弹出窗口
 */
function updEmployee(employeeId) {
	formReset('employeeForm');
	doPost('/employee/queryOne', {id: employeeId}, function (result) {
		if (!result.result) {
			alertMsg(result.msg);
		} else {
			$("#employeeForm #employee_id").val(result.data.id);
			$("#employeeForm #employee_name").val(result.data.name);
			$("#employeeForm #employee_age").val(result.data.age);
			$("#employeeForm #employee_address").val(result.data.address);
			$("#employeeForm #employee_departmentName").val(result.data.departmentName);
			$("#employeeForm #employee_departmentId").val(result.data.departmentId);
			$("#employeeForm #employee_desc").val(result.data.desc);
			if(result.data.sex == '1') {
				$('#employeeForm #sex_1').prop('checked', true);
			} else {
				$('#employeeForm #sex_0').prop('checked', true);
			}
			openContent('修改员工', 500, 'employeeContent');
		}
	});
}


/**
 * 删除员工
 */
function delEmployee(employeeId) {
	doPost('/employee/delEmployee', {id: employeeId}, function (result) {
		if (!result.result) {
			alertMsg(result.msg);
		} else {
			let currentNode = getSelectedNode('departmentTree');
			initEmployeeList(currentNode.id);
			alertMsg('删除成功', function () {
				closeLayer();
			});
		}
	});
}

/**
 * 保存员工信息，后台执行 新增或修改
 */
function saveEmployee() {
	let data = $('#employeeForm').getFormJson();
	let url = '/employee/addEmployee';
	if (data.id) {
		url = '/employee/updEmployee';
	}
	doPost(url, data, function (result) {
		if (!result.result) {
			alertMsg(result.msg);
		} else {
			initEmployeeList(data.departmentId);
			alertMsg('保存成功', function () {
				closeLayer();
			});
		}
	});
}</code>
</pre>

<p><b>路由文件</b></p>

<p>编辑lib/routes/department.js文件</p>
<pre class="language-javascript">
<code>// lib/routes/department.js

const express = require('express');
const department = require('../service/department');

let router = express.Router();

/**
 * 获取部署数据
 */
router.post('/treeData', function (req, res) {
	department.departmentTree(function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			res.json({result: true, data: data});
		}
	});
});

/**
 * 获取一条记录
 */
router.post('/queryOne', function (req, res) {
	department.queryDepartmentById(req.body.id, function (err, data) {
		if (err) {
			res.json({'result': false, 'msg': err.message});
		} else {
			res.json({result: true, data: data});
		}
	});
});

/**
 * 添加部门
 */
router.post('/addDepartment', function (req, res) {
	department.addDepartment(req.body, function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			res.json({result: true, data: {type: 'add', data: data}});
		}
	});
});

/**
 * 修改部门
 */
router.post('/updDepartment', function (req, res) {
	department.updDepartment(req.body, function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			res.json({result: true, data: {type: 'upd', data: data}});
		}
	});
});

/**
 * 删除部门
 */
router.post('/delDepartment', function (req, res) {
	department.delDepartment(req.body.id, function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			res.json({result: true, data: data});
		}
	});
});

module.exports = router;</code>
</pre>

<p>编辑 lib/routes/employee.js文件</p>
<pre class="language-javascript">
<code>// lib/routes/employee.js

const express = require('express');
const employee = require('../service/employee');

let router = express.Router();

/**
 * 获取员工列表信息
 */
router.post('/queryList', function (req, res) {
	employee.queryList(req.body.departmentId, function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			res.json({result: true, data: data});
		}
	});
});

/**
 * 添加员工信息
 */
router.post('/addEmployee', function (req, res) {
	employee.addEmployee(req.body, function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			res.json({result: true, data: data});
		}
	});
});

/**
 * 删除员工记录
 */
router.post('/delEmployee', function (req, res) {
	employee.delEmployee(req.body.id, function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			res.json({result: true});
		}
	});
});

/**
 * 查询一条记录
 */
router.post('/queryOne', function (req, res) {
	employee.queryOne(req.body.id, function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			res.json({result: true, data: data});
		}
	});
});

/**
 * 修改员工记录
 */
router.post('/updEmployee', function (req, res) {
	employee.updEmployee(req.body, function (err, data) {
		if (err) {
			res.json({result: false, msg: err.message});
		} else {
			res.json({result: true});
		}
	});
});

module.exports = router;</code>
</pre>

<p><b>编辑业务处理文件</b></p>

<p>创建 lib/service/department.js文件</p>
<pre class="language-none">
<code>$ touch lib/service/department.js</code>
</pre>

<p>编辑 lib/service/department.js文件</p>
<pre class="language-javascript">
<code>// lib/service/department.js
const uuid = require('node-uuid');
const mysqlUtil = require('../utils/mysqlUtil');

/**
 * 获取部门数据
 */
exports.departmentTree = function (callback) {
	mysqlUtil.query('select * from department order by createTime asc', callback);
};

/**
 * 根据id获取部门信息
 */
exports.queryDepartmentById = function (id, callback) {
	mysqlUtil.query({
		sql: 'select a.id, a.name, a.pId, (select name from department where id = a.pId) pName from department a where a.id = ?',
		values: [id]
	}, function (err, data) {
		if (err) {
			callback(err);
		} else {
			if (data.length !== 1) {
				callback(new Error('返回记录数量不正确'), data);
			} else {
				callback(null, data[0]);
			}
		}
	});
};

/**
 * 添加部门信息
 */
exports.addDepartment = function (obj, callback) {
	obj.pId = obj.pId || null;
	obj.id = uuid.v4();
	mysqlUtil.save('department', obj, function (err, data) {
		if (err) {
			callback(err);
		} else {
			mysqlUtil.findById('department', obj.id, callback);
		}
	});
};

/**
 * 修改部门信息
 */
exports.updDepartment = function (obj, callback) {
	mysqlUtil.query({
		sql: 'update department set name = ? where id = ?',
		values: [obj.name, obj.id]
	}, function (err, data) {
		if (err) {
			callback(err);
		} else {
			mysqlUtil.findById('department', obj.id, callback);
		}
	});
};

/**
 * 删除部门信息
 */
exports.delDepartment = function (id, callback) {
	mysqlUtil.query({
		sql: 'select count(1) cnt from department where pId = ?',
		values: [id]
	}, function (err, data) {
		if (err) {
			callback(err);
		} else {
			if (data[0].cnt !== 0) {
				callback(new Error('有下级部门，无法删除!'));
			} else {
				mysqlUtil.query({
					sql: 'select count(1) cnt from employee where departmentId = ?',
					values: [id]
				}, function (err, data) {
					if (err) {
						callback(err);
					} else {
						if (data[0].cnt !== 0) {
							callback(new Error('该部门有员工，无法删除!'));
						} else {
							mysqlUtil.delById('department', id, callback);
						}
					}
				});
			}
		}
	});
};</code>
</pre>

<p>创建 lib/service/employee.js文件</p>
<pre class="language-none">
<code>$ touch lib/service/employee.js</code>
</pre>

<p>编辑 lib/service/employee.js文件</p>
<pre class="language-javascript">
<code>// lib/service/employee.js

const uuid = require('node-uuid');
const mysqlUtil = require('../utils/mysqlUtil');

/**
 * 获取员工列表
 */
exports.queryList = function (departmentId, callback) {
	mysqlUtil.query({
		sql: 'select a.id, a.name, a.departmentId, (select name from department where id = a.departmentId) departmentName, a.age, a.sex, a.address, a.desc from employee a where a.departmentId = ?',
		values: [departmentId]
	}, callback);
};

/**
 * 添加员工
 */
exports.addEmployee = function (obj, callback) {
	obj.id = uuid.v4();
	mysqlUtil.save('employee', obj, callback);
};

/**
 * 删除员工
 */
exports.delEmployee = function (id, callback) {
	mysqlUtil.delById('employee', id, callback);
}

/**
 * 修改员工
 */
exports.updEmployee = function (obj, callback) {
	delete obj.departmentId;
	mysqlUtil.update('employee', obj, callback);
}

/**
 * 获取一条员工记录
 */
exports.queryOne = function (id, callback) {
	mysqlUtil.query ({
		sql: 'select a.id, a.name, a.departmentId, (select name from department where id = a.departmentId) departmentName, a.age, a.sex, a.address, a.desc from employee a where a.id = ?',
		values: [id]
	}, function (err, data) {
		if (err) {
			callback(err);
		} else {
			if (data.length !== 1) {
				callback(new Error('返回记录不正确'));
			} else {
				callback(null, data[0]);
			}
		}
	});
}</code>
</pre>

<h3>运行效果</h3>
<p>至此，利用express、ejs、mysql完成一个简单的员工管理模块，可以运行app.js文件，浏览器中访问应用了</p>

<img alt="" width='700px' src="/images/nodejs/2017/02/10/019.png">
<img alt="" width='700px' src="/images/nodejs/2017/02/10/020.png">
</p>
	</div>
	<div class='post-footer'>
		<div class="meta">
			<div class="info">
				<span>日期:</span>
				<span>2017-02-10</span>
				<span class='delimiter'>|</span>
				<span>分类:</span>
				<a href='/pages/archives/category/nodejs'>nodejs</a>
				<span class='delimiter'>|</span>
				<span>标签:</span>
				<a href='/pages/archives/tags/javascript'>javascript</a> <a href='/pages/archives/tags/nodejs'>nodejs</a>
			</div>
		</div>
	</div>
</div>

			<div class="pagination">
	<ul class="clearfix">
		<li class="pre pagbuttons">
	<a role="navigation" href="/pages/posts/canvas/2017/02/16/Canvas介绍/" class="btn">
		<i class="baseline"></i>
		上一篇
	</a>
</li>


		<li class="next pagbuttons">
	<a role="navigation" href="/pages/posts/java/2017/02/02/java可变参数/" class="btn">
		<i class="baseline"></i>
		下一篇
	</a>
</li>


	</ul>
</div>


			<!-- 多说评论框 start -->
<div class='pinglun-box'>
	<div class="ds-thread" data-thread-key="30" data-title="express-mysql-ejs员工管理系统" data-url="http://www.shenjinxiang.com/pages/posts/nodejs/2017/02/10/express-mysql-ejs员工管理系统/"></div>
</div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"shenjinxiang"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
<!-- 多说公共JS代码 end -->

		</div>
	</div>
</div>



<script src="/plugin/jquery.js"></script>
<script src="/plugin/prism/prism.js"></script>
<script src="/js/common.js"></script>
</body>
</html>
