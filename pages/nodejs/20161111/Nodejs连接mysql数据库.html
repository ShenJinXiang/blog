<!doctype html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<meta content="yes" name="apple-mobile-web-app-capable">
	<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
	<meta content="telephone=no" name="format-detection">
	<meta name="keywords" content="LiksStar ShenJinXiang 申锦祥 JavaScript 博客">
	<meta name="description" content="LiksStar ShenJinXiang 申锦祥 JavaScript 博客">
	<link rel='icon' href="../../../images/title.ico" type="image/x-ico" />
	<link rel="stylesheet" href="../../../plugin/prism/prism.css">
	<link rel="stylesheet" href="../../../css/style.css">
	<title>LikeStar</title>
</head>
<body>
<div id="temp_content" style="display: none;">
	<div class="post-content">
<!-- 正文开始 -->
<p>开发过程中通常要涉及到数据库操作，node.js开发也免不了要操作数据库，由于比较熟悉mysql，所以先从mysql开始总结</p>
<h3>环境准备</h3>
<p>安装nodejs的mysql包，GitHub地址：<a href='https://github.com/mysqljs/mysql.git'>https://github.com/mysqljs/mysql.git</a></p>
<pre class='language-'>
<code>
npm install mysql --save
</code>
</pre>
<br><hr><br>
<h3>简单例子</h3>
<p>代码如下：</p>
<pre class='line-numbers language-javascript'>
<code>
// 引入mysql
var mysql = require('mysql');

// 创建链接 配置链接属性
var conn = mysql.createConnection({
	host: 'localhost',
	user: 'root',
	password: 'root',
	port: 3306,
	database: 'nodejs'
});

// 启用链接
conn.connect();

// 执行查询nodejs.user表中的所有记录
conn.query('select * from user', function (err, rows, fields) {
	if (err) {
		throw err;
	}

	// 输出查询结果
	console.log(rows);
});

// 关闭链接
conn.end();
</code>
</pre>
<p>运行结果：</p>
<pre class='line-numbers result-code'>
<code>
[ RowDataPacket { id: 1, name: '张三', age: 18 },
  RowDataPacket { id: 2, name: '李四', age: 19 },
  RowDataPacket { id: 3, name: '王五', age: 20 } ]
</code>
</pre>
<br><hr><br>
<h3>带数据查询</h3>
<p>查询id是1的用户信息</p>
<pre class='line-numbers language-javascript'>
<code>
conn.query('select * from user where id = ?', [1], function (err, rows, fields) {
	if (err) throw err;
	console.log(rows);
});
</code>
</pre>
<p>运行结果：</p>
<pre class='line-numbers result-code'>
<code>
[ RowDataPacket { id: 1, name: '张三', age: 18 } ]
</code>
</pre>
<br><hr><br>
<h3>插入、修改和删除操作</h3>
<p><b>插入数据</b></p>
<pre class='line-numbers language-javascript'>
<code>
var sql = 'insert into user (`name`, `age`) values (?, ?)';
conn.query(sql, ['刘备', 46], function (err, results) {
	if (err) throw err;
	console.log(results);
});
</code>
</pre>
<p>运行结果：</p>
<pre class='line-numbers result-code'>
<code>
OkPacket {
  fieldCount: 0,
  affectedRows: 1,
  insertId: 4,
  serverStatus: 2,
  warningCount: 0,
  message: '',
  protocol41: true,
  changedRows: 0 }
</code>
</pre>
<p>查看运行结果，可以知道新插入的记录的id值为：4，再次查询user表中所有记录：</p>
<pre class='line-numbers result-code'>
<code>
[ RowDataPacket { id: 1, name: '张三', age: 18 },
  RowDataPacket { id: 2, name: '李四', age: 19 },
  RowDataPacket { id: 3, name: '王五', age: 20 },
  RowDataPacket { id: 4, name: '刘备', age: 46 } ]
</code>
</pre>
<br>
<p><b>修改记录</b></p>
<pre class='line-numbers language-javascript'>
<code>
var sql = 'update user set name = ?, age = ? where id = ?';
conn.query(sql, ['曹操', 66, 1], function (err, results) {
	if (err) throw err;
	console.log(results);
});
</code>
</pre>
<p>运行结果：</p>
<pre class='line-numbers result-code'>
<code>
OkPacket {
  fieldCount: 0,
  affectedRows: 1,
  insertId: 0,
  serverStatus: 2,
  warningCount: 0,
  message: '(Rows matched: 1  Changed: 1  Warnings: 0',
  protocol41: true,
  changedRows: 1 }
</code>
</pre>
<p>再次查询user表中所有记录：</p>
<pre class='line-numbers result-code'>
<code>
[ RowDataPacket { id: 1, name: '曹操', age: 66 },
  RowDataPacket { id: 2, name: '李四', age: 19 },
  RowDataPacket { id: 3, name: '王五', age: 20 },
  RowDataPacket { id: 4, name: '刘备', age: 46 } ]
</code>
</pre>
<br>
<p><b>删除记录</b></p>
<pre class='line-numbers language-javascript'>
<code>
var sql = 'delete from user where id = ?';
conn.query(sql, [2], function (err, results) {
	if (err) throw err;
	console.log(results);
});
</code>
</pre>
<p>运行结果：</p>
<pre class='line-numbers result-code'>
<code>
OkPacket {
  fieldCount: 0,
  affectedRows: 1,
  insertId: 0,
  serverStatus: 2,
  warningCount: 0,
  message: '',
  protocol41: true,
  changedRows: 0 }
</code>
</pre>
<p>再次查询user表中所有记录：</p>
<pre class='line-numbers result-code'>
<code>
[ RowDataPacket { id: 1, name: '曹操', age: 66 },
  RowDataPacket { id: 3, name: '王五', age: 20 },
  RowDataPacket { id: 4, name: '刘备', age: 46 } ]
</code>
</pre>
<br>
<p><b>另外的传值方式</b></p>
<p>通过上面的练习，我们知道conn.query()方法可以接收三个参数：sql、值、回调函数。还有另外一种传递参数的方式：</p>
<pre class='line-numbers language-javascript'>
<code>
conn.query({
	sql: 'update user set name = ?, age = ? where id = ?',
	timeout: 10000, // 10秒超时
	values: ['赵云', 21, 3]
}, function (err, results) {
	if (err) throw err;
	console.log(results);
});
</code>
</pre>
<p>运行结果：</p>
<pre class='line-numbers result-code'>
<code>
OkPacket {
  fieldCount: 0,
  affectedRows: 1,
  insertId: 0,
  serverStatus: 2,
  warningCount: 0,
  message: '(Rows matched: 1  Changed: 1  Warnings: 0',
  protocol41: true,
  changedRows: 1 }
</code>
</pre>
<p>nodejs.user表中的记录：</p>
<pre class='line-numbers result-code'>
<code>
[ RowDataPacket { id: 1, name: '曹操', age: 66 },
  RowDataPacket { id: 3, name: '赵云', age: 21 },
  RowDataPacket { id: 4, name: '刘备', age: 46 } ]  
</code>
</pre>
<br><hr><br>
<h3>数据库链接池</h3>
<p>建立数据库链接池，并执行查询操作</p>
<pre class='line-numbers language-javascript'>
<code>
ar mysql = require('mysql');

var pool = mysql.createPool({
	connectionLimit: 10,
	host: 'localhost',
	user: 'root',
	password: 'root',
	database: 'nodejs',
	port: 3306
});

pool.query('select * from user', function (err, rows, fields) {
	if (err) throw err;
	console.log(rows);
});
</code>
</pre>
<p>运行结果：</p>
<pre class='line-numbers result-code'>
<code>
[ RowDataPacket { id: 1, name: '曹操', age: 66 },
  RowDataPacket { id: 3, name: '赵云', age: 21 },
  RowDataPacket { id: 4, name: '刘备', age: 46 } ]
</code>
</pre>
<p>数据库链接池中获取链接</p>
<pre class='line-numbers language-javascript'>
<code>
pool.getConnection(function (err, connection) {
	connection.query('select * from user', function (err, rows) {
		connection.release();	// 返回链接给链接池
		console.log(rows);
	});
});
</code>
</pre>
<!-- 正文结束 -->
	</div>
</div>
<script src="../../../plugin/jquery/jquery.js"></script>
<script src="../../../plugin/prism/prism.js"></script>
<script src="../../../js/main.js"></script>
<script><!--{{{-->
$(function(){
	LS.init({
		'currentMenu' : 1,
		'sidebar' : ['date', 'category', 'tags', 'post'],
		'content' : {
			'type' : 'post',
			'id' : 16
		}
	});

});
</script><!--}}}-->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript"><!--{{{-->
var duoshuoQuery = {short_name:"shenjinxiang"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script><!--}}}-->
<!-- 多说公共JS代码 end -->
</body>
</html>





